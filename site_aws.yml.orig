---
aws_access_key: AKIAIMX3AFAZG2DTMPLQ
aws_secret_key: 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

tasks:
  - name: "Launch instance"
    ec2:
       key_name: winston
       instance_type: t2.micro
       image: ami-2d39803a
       wait: yes
       group: service
       count: 3
       assign_public_ip: yes
    register: ec2
 

  - name: Add new instance to host group
    add_host: hostname={{ item.public_ip }} groupname=compucorp-ec2 ansible_user=ubuntu ansible_ssh_private_key_file=/home/winston/Sysadmin/winston.pem
    with_items: '{{ec2.instances}}'

  - name: Wait for SSH
    wait_for host={{ item.public_dns_name}} port=22 delay=60 timeout=320 state=started
    with_items:  '{{ec2.instances}}'

- name: Install services
  hosts: compucorp-ec2
  become: True
  gather_facts: True
  roles:
    - hostname
